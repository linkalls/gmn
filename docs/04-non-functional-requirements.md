# 非機能要件

## 1. パフォーマンス要件

### NFR-001: 起動時間
- **要件**: コマンド起動から処理開始まで 100ms 以下
- **測定方法**: `time geminimini --help`
- **根拠**: スクリプト統合時の体感速度

### NFR-002: メモリ使用量
- **要件**: 実行時メモリ使用量 50MB 以下（通常利用時）
- **測定方法**: `/usr/bin/time -l geminimini -p "test"`
- **例外**: 大きなファイル/ディレクトリ読み込み時は除く

### NFR-003: バイナリサイズ
- **要件**: 単一バイナリサイズ 20MB 以下
- **測定方法**: `ls -lh geminimini`
- **ビルドオプション**: `-ldflags="-s -w"` でシンボル削除

### NFR-004: レイテンシ
- **要件**: API レスポンス受信から出力開始まで 10ms 以下
- **条件**: ストリーミング時、最初のチャンク受信後
- **測定方法**: タイムスタンプ比較

### NFR-005: スループット
- **要件**: ストリーミング出力の遅延なし
- **条件**: API からのチャンク受信と同期して出力
- **バッファリング**: なし（即時出力）

## 2. 信頼性要件

### NFR-101: エラーハンドリング
- **要件**: すべてのエラーを適切にハンドリングし、ユーザーに通知する
- **パニック**: recover でキャッチし、スタックトレースをログ出力
- **終了コード**: エラー種別に応じた終了コードを返す

### NFR-102: タイムアウト
- **要件**: すべてのネットワーク操作にタイムアウトを設定する
- **デフォルト**: 5 分
- **設定可能**: `--timeout` フラグ

### NFR-103: リトライ
- **要件**: 一時的なエラーに対してリトライを行う
- **対象**: HTTP 429 (Too Many Requests), 503 (Service Unavailable)
- **戦略**: 指数バックオフ（1s, 2s, 4s, 最大3回）

### NFR-104: グレースフルシャットダウン
- **要件**: SIGINT/SIGTERM でクリーンに終了する
- **処理**: MCP 接続のクローズ、一時ファイルの削除
- **タイムアウト**: 5 秒

## 3. セキュリティ要件

### NFR-201: 認証情報保護
- **要件**: 認証トークンをログに出力しない
- **実装**: トークンのマスキング処理

### NFR-202: TLS 通信
- **要件**: すべての外部通信は TLS 1.2 以上を使用する
- **証明書検証**: システムの CA 証明書を使用

### NFR-203: 入力検証
- **要件**: 外部入力を適切に検証する
- **対象**: ファイルパス、URL、MCP サーバー設定
- **パストラバーサル**: 防止

### NFR-204: 機密情報の扱い
- **要件**: 機密情報を一時ファイルに書き出さない
- **メモリ**: 使用後にクリア（ベストエフォート）

## 4. 互換性要件

### NFR-301: OS 互換性
- **要件**: 主要 OS で動作する
- **対象**:
  - macOS 12 (Monterey) 以降
  - Linux (glibc 2.17 以降)
  - Windows 10/11

### NFR-302: アーキテクチャ互換性
- **要件**: 主要アーキテクチャをサポートする
- **対象**:
  - amd64 (x86_64)
  - arm64 (Apple Silicon, AWS Graviton)

### NFR-303: 公式 CLI 互換性
- **要件**: 公式 Gemini CLI の設定ファイルと互換性を維持する
- **対象**:
  - `~/.gemini/settings.json`
  - `~/.gemini/oauth_creds.json`
  - `~/.gemini/google_accounts.json`
- **バージョン**: Gemini CLI 0.27.0 時点の形式

### NFR-304: MCP 互換性
- **要件**: MCP (Model Context Protocol) 仕様に準拠する
- **バージョン**: MCP 1.0
- **参照**: https://modelcontextprotocol.io/

## 5. 運用性要件

### NFR-401: ログ出力
- **要件**: 適切なログレベルでログを出力する
- **レベル**: ERROR, WARN, INFO, DEBUG
- **デフォルト**: ERROR, WARN のみ標準エラー出力
- **デバッグ**: `--debug` で全レベル出力

### NFR-402: 診断情報
- **要件**: トラブルシューティング用の情報を提供する
- **コマンド**: `geminimini --debug`
- **出力**: API リクエスト/レスポンス、設定読み込み結果

### NFR-403: シグナル処理
- **要件**: 標準的なシグナルを処理する
- **SIGINT (Ctrl+C)**: 処理中断、クリーンアップ、終了コード 130
- **SIGTERM**: グレースフルシャットダウン
- **SIGPIPE**: 無視（パイプ切断時の継続動作）

## 6. 保守性要件

### NFR-501: コード品質
- **要件**: 一貫したコードスタイルを維持する
- **ツール**: `gofmt`, `golint`, `go vet`
- **CI**: 全ツールがパスすること

### NFR-502: テストカバレッジ
- **要件**: コアロジックのテストカバレッジ 80% 以上
- **対象**: `internal/` 配下のパッケージ
- **除外**: main.go, 外部 I/O 依存部分

### NFR-503: ドキュメント
- **要件**: 公開 API にドキュメントコメントを付与する
- **形式**: Go Doc 形式
- **対象**: エクスポートされた型、関数、定数

### NFR-504: 依存関係
- **要件**: 依存関係を最小限に抑える
- **直接依存**: 10 パッケージ以下
- **更新**: 月次でセキュリティアップデートを確認

## 7. ビルド・デプロイ要件

### NFR-601: ビルド再現性
- **要件**: 同じソースから同じバイナリをビルドできる
- **実装**: `go.sum` によるバージョン固定
- **環境変数**: `CGO_ENABLED=0` で静的リンク

### NFR-602: クロスコンパイル
- **要件**: 単一マシンから全プラットフォーム向けビルドができる
- **ツール**: `GOOS` / `GOARCH` 環境変数
- **CI**: GitHub Actions でマトリクスビルド

### NFR-603: リリース成果物
- **要件**: プラットフォームごとのバイナリを配布する
- **形式**:
  - `geminimini-darwin-amd64`
  - `geminimini-darwin-arm64`
  - `geminimini-linux-amd64`
  - `geminimini-linux-arm64`
  - `geminimini-windows-amd64.exe`

## 8. 非機能要件サマリー

| カテゴリ | ID | 要件 | 目標値 |
|---------|-----|------|--------|
| パフォーマンス | NFR-001 | 起動時間 | 100ms 以下 |
| パフォーマンス | NFR-002 | メモリ使用量 | 50MB 以下 |
| パフォーマンス | NFR-003 | バイナリサイズ | 20MB 以下 |
| 信頼性 | NFR-102 | タイムアウト | 5 分（設定可能） |
| 信頼性 | NFR-103 | リトライ | 最大 3 回 |
| 互換性 | NFR-303 | 公式 CLI 互換 | 設定ファイル 100% |
| 保守性 | NFR-502 | テストカバレッジ | 80% 以上 |
| 保守性 | NFR-504 | 直接依存 | 10 パッケージ以下 |
