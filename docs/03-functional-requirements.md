# 機能要件

## 1. コア機能

### FR-001: プロンプト送信

- **概要**: ユーザーが指定したプロンプトを Gemini API に送信する
- **入力**: プロンプト文字列（`-p` フラグ）
- **出力**: モデルからの応答
- **優先度**: 必須

### FR-002: モデル選択

- **概要**: 使用する Gemini モデルを指定できる
- **入力**: モデル名（`-m` フラグ）
- **デフォルト**:
  - free-tier: `gemini-2.5-flash`
  - standard-tier (Pro): `gemini-3-pro-preview`
- **フォールバック**: モデルエラー時は自動的に以下の順序でフォールバック
  - `gemini-3-pro-preview` → `gemini-3-flash-preview` → `gemini-2.5-flash`
- **対応モデル**:
  - `gemini-3-pro-preview`
  - `gemini-3-flash-preview`
  - `gemini-2.5-flash`
  - `gemini-2.5-pro`
  - その他 API がサポートするモデル
- **優先度**: 必須

### FR-003: 出力形式選択

- **概要**: 出力形式を選択できる
- **入力**: 形式名（`-o` フラグ）
- **対応形式**:
  - `text` - プレーンテキスト（デフォルト）
  - `json` - 構造化 JSON
  - `stream-json` - ストリーミング NDJSON
- **優先度**: 必須

### FR-004: ストリーミング出力

- **概要**: モデルからの応答をリアルタイムでストリーミング出力する
- **条件**: `-o stream-json` 指定時
- **出力**: NDJSON 形式のイベントストリーム
- **優先度**: 必須

## 2. 認証機能

### FR-101: OAuth トークン読み込み

- **概要**: 公式 Gemini CLI の OAuth トークンを読み込む
- **読み込み元**:
  1. macOS Keychain（サービス名: `gemini-cli-oauth`）
  2. `~/.gemini/oauth_creds.json`（フォールバック）
- **優先度**: 必須

### FR-102: トークンリフレッシュ

- **概要**: 期限切れトークンを自動的にリフレッシュする
- **条件**: `expiry_date` が現在時刻より過去
- **処理**: Google OAuth2 エンドポイントでリフレッシュ
- **失敗時**: エラーメッセージと再認証の案内を表示
- **優先度**: 必須

## 3. 入力機能

### FR-201: 標準入力読み込み

- **概要**: パイプからの標準入力をプロンプトに追加する
- **処理**: 標準入力の内容 + プロンプトを結合
- **例**: `cat file.txt | geminimini -p "要約して"`
- **優先度**: 必須

### FR-202: ファイル読み込み

- **概要**: 指定したファイルをコンテキストに含める
- **入力**: ファイルパス（`-f` フラグ、複数可）
- **処理**: ファイル内容をプロンプトの前に追加
- **優先度**: 高

### FR-203: ディレクトリ読み込み

- **概要**: 指定したディレクトリのファイルをコンテキストに含める
- **入力**: ディレクトリパス（`-d` フラグ、複数可）
- **処理**: ディレクトリ内のファイルを再帰的に読み込み
- **除外**: `.gitignore` パターンに従う
- **優先度**: 中

## 4. MCP 機能

### FR-301: MCP サーバー接続

- **概要**: 設定された MCP サーバーに接続する
- **設定**: `~/.gemini/settings.json` の `mcpServers`
- **トランスポート**: Stdio, SSE, HTTP
- **優先度**: 高

### FR-302: Stdio トランスポート

- **概要**: ローカルプロセスとして MCP サーバーを起動・通信する
- **設定項目**:
  - `command` - 実行コマンド
  - `args` - コマンド引数
  - `env` - 環境変数
  - `cwd` - 作業ディレクトリ
- **優先度**: 高

### FR-303: SSE トランスポート

- **概要**: Server-Sent Events で MCP サーバーと通信する
- **設定項目**:
  - `url` - SSE エンドポイント URL
  - `headers` - HTTP ヘッダー
- **優先度**: 中

### FR-304: HTTP トランスポート

- **概要**: Streamable HTTP で MCP サーバーと通信する
- **設定項目**:
  - `url` - HTTP エンドポイント URL
  - `headers` - HTTP ヘッダー
- **優先度**: 中

### FR-305: ツール発見

- **概要**: MCP サーバーから利用可能なツール一覧を取得する
- **プロトコル**: `tools/list` リクエスト
- **結果**: ツール名、説明、パラメータスキーマ
- **優先度**: 高

### FR-306: ツール実行

- **概要**: モデルの要求に応じて MCP ツールを実行する
- **プロトコル**: `tools/call` リクエスト
- **処理フロー**:
  1. モデルが `functionCall` を返却
  2. 対応する MCP ツールを特定
  3. MCP サーバーにツール実行を要求
  4. 結果をモデルに返却
- **優先度**: 高

### FR-307: プロンプト発見

- **概要**: MCP サーバーからプロンプトテンプレート一覧を取得する
- **プロトコル**: `prompts/list` リクエスト
- **結果**: プロンプト名、説明、引数スキーマ
- **優先度**: 中

### FR-308: プロンプト取得

- **概要**: プロンプトテンプレートを引数で展開して取得する
- **プロトコル**: `prompts/get` リクエスト
- **用途**: 定型プロンプトの再利用
- **優先度**: 中

### FR-309: リソース発見

- **概要**: MCP サーバーからリソース一覧を取得する
- **プロトコル**: `resources/list` リクエスト
- **結果**: リソースURI、名前、MIMEタイプ
- **優先度**: 中

### FR-310: リソース読み取り

- **概要**: MCP サーバーからリソースを読み取る
- **プロトコル**: `resources/read` リクエスト
- **用途**: 外部データソースへのアクセス
- **優先度**: 中

## 5. 設定機能

### FR-401: 設定ファイル読み込み

- **概要**: 公式 CLI と互換の設定ファイルを読み込む
- **パス**: `~/.gemini/settings.json`
- **優先度**: 必須

### FR-402: 環境変数オーバーライド

- **概要**: 環境変数で設定を上書きできる
- **対応変数**:
  - `GEMINIMINI_MODEL` - デフォルトモデル
  - `GEMINIMINI_TIMEOUT` - タイムアウト
  - `GEMINIMINI_DEBUG` - デバッグモード
- **優先度**: 中

### FR-403: プロジェクト設定

- **概要**: プロジェクトディレクトリの設定を読み込む
- **パス**: `./.gemini/settings.json`
- **マージ**: グローバル設定にマージ（プロジェクト設定優先）
- **優先度**: 低

## 6. 出力機能

### FR-501: テキスト出力（ストリーミング）

- **概要**: モデルの応答をリアルタイムでプレーンテキスト出力する
- **動作**: API ストリーミングを使用し、チャンク受信ごとに即時出力
- **出力先**: 標準出力
- **用途**: 人間が見る用途
- **優先度**: 必須

### FR-502: JSON 出力（非ストリーミング）

- **概要**: 生成完了後に構造化された JSON で出力する
- **動作**: API レスポンス全体を待ってから出力
- **含む情報**: モデル名、応答、トークン使用量、終了理由
- **用途**: スクリプトでのパース
- **優先度**: 必須

### FR-503: ストリーミング JSON 出力

- **概要**: イベントごとに NDJSON で出力する
- **動作**: API ストリーミングを使用し、イベントごとに JSON 行を出力
- **イベント種別**: `start`, `content`, `tool_call`, `tool_result`, `done`, `error`
- **用途**: リアルタイム処理が必要なスクリプト
- **優先度**: 必須

### FR-504: エラー出力

- **概要**: エラーを標準エラー出力に出力する
- **形式**: 出力形式に応じて text または json
- **優先度**: 必須

## 7. 補助機能

### FR-601: バージョン表示

- **概要**: バージョン情報を表示する
- **コマンド**: `geminimini --version` または `-v`
- **出力**: バージョン番号、ビルド情報
- **優先度**: 必須

### FR-602: ヘルプ表示

- **概要**: 使用方法を表示する
- **コマンド**: `geminimini --help` または `-h`
- **出力**: コマンド一覧、フラグ説明
- **優先度**: 必須

### FR-603: デバッグモード

- **概要**: 詳細なデバッグ情報を出力する
- **コマンド**: `geminimini --debug`
- **出力**: API リクエスト/レスポンス、MCP 通信ログ
- **優先度**: 中

## 8. 機能優先度マトリクス

| 優先度 | 機能 ID | 機能名                         |
| ------ | ------- | ------------------------------ |
| 必須   | FR-001  | プロンプト送信                 |
| 必須   | FR-002  | モデル選択                     |
| 必須   | FR-003  | 出力形式選択                   |
| 必須   | FR-004  | ストリーミング出力             |
| 必須   | FR-101  | OAuth トークン読み込み         |
| 必須   | FR-102  | トークンリフレッシュ           |
| 必須   | FR-201  | 標準入力読み込み               |
| 必須   | FR-401  | 設定ファイル読み込み           |
| 必須   | FR-501  | テキスト出力（ストリーミング） |
| 必須   | FR-502  | JSON 出力（非ストリーミング）  |
| 必須   | FR-503  | ストリーミング JSON 出力       |
| 必須   | FR-504  | エラー出力                     |
| 必須   | FR-601  | バージョン表示                 |
| 必須   | FR-602  | ヘルプ表示                     |
| 高     | FR-202  | ファイル読み込み               |
| 高     | FR-301  | MCP サーバー接続               |
| 高     | FR-302  | Stdio トランスポート           |
| 高     | FR-305  | ツール発見                     |
| 高     | FR-306  | ツール実行                     |
| 中     | FR-203  | ディレクトリ読み込み           |
| 中     | FR-303  | SSE トランスポート             |
| 中     | FR-304  | HTTP トランスポート            |
| 中     | FR-307  | プロンプト発見                 |
| 中     | FR-308  | プロンプト取得                 |
| 中     | FR-309  | リソース発見                   |
| 中     | FR-310  | リソース読み取り               |
| 中     | FR-402  | 環境変数オーバーライド         |
| 中     | FR-603  | デバッグモード                 |
| 低     | FR-403  | プロジェクト設定               |
